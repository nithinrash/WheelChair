<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel chair control</title>
     <link rel="stylesheet" href="styles.css">
    <style>


    </style>
</head>
<body>
    <h1>Whell chair control</h1>

    <!-- Toggle Switch -->
    <label class="switch">
        <input type="checkbox" id="toggleSwitch" onchange="toggleDisplay()">
        <span class="slider"></span>
    </label>

    <!-- <div id="direction">Loading...</div> -->
    
    <div id="image-container" style="color: #cdcccd;">
        <iframe id="giphy-iframe" src="https://giphy.com/embed/IeQTqWKqQGghiKS9qU" width="480" height="442" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
    </div>

    <!-- Joystick Container -->
    <div id="joystick"></div>

    <!-- Button to Start Listening -->
    <button id="startListeningBtn" onclick="startSpeechRecognition()">Start Listening</button>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>
    
    <!-- Include Firebase SDK -->
    <script type="module">
        // Import the necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.6.6/firebase-database.js";
    
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7KZJgRlu1mpwJy7_Q1GQ13ziBVvw66IU",
            authDomain: "smart-wheel-chair-eccdf.firebaseapp.com",
            databaseURL: "https://smart-wheel-chair-eccdf-default-rtdb.firebaseio.com",
            projectId: "smart-wheel-chair-eccdf",
            storageBucket: "smart-wheel-chair-eccdf.firebasestorage.app",
            messagingSenderId: "792677170249",
            appId: "1:792677170249:web:9a70ea01cfc9636035d398"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const toggleFlagRef = ref(database, 'motion/flag');
        const directionRef = ref(database, 'motion/direction');
        const joystickContainer = document.getElementById('joystick');
    
        // Joystick Options
        const options = {
            zone: joystickContainer,
            mode: 'static',
            position: { left: '50%', top: '85%' }, // Position it towards the bottom of the container
            color: 'black', // Make the default joystick invisible
            size: 200,
            lockX: false,
            lockY: false,
            catchDistance: 50,
            threshold: 0.1,
            multitouch: true,
            fadeTime: 1000,
            restOpacity: 0.5,
            dynamicPage: true
        };
    
        const joystick = nipplejs.create(options);
    
        joystick.on('move', function (evt, data) {
            const angleDegree = data.angle ? data.angle.degree : 0; // Ensure angle is defined
            let value;
    
            if (data.distance < 1) {  // Assuming the center zone is less than 1
                value = 0; // Center position
                document.getElementById('direction').innerText = value;
            } else if (angleDegree >= 95 && angleDegree < 100) {
                value = 5; // Up
            } else if (angleDegree >= 260 && angleDegree < 280) {
                value = 10; // Down
            } else if (angleDegree > 180 && angleDegree < 190) {
                value = 15; // Left
            } else if (angleDegree >= 350 || angleDegree < 20) {
                value = 20; // Right
            } else {
                value = 0;
            }
    
            console.log("Joystick Angle:", angleDegree, "Value:", value);
            set(directionRef, value) // Update Firebase with new value
                .then(() => console.log("Direction value updated in Firebase:", value))
                .catch((error) => console.error("Error updating direction:", error));
        });
    
        joystick.on('end', function () {
            set(directionRef, 0) // Reset to center when joystick is released
                .then(() => console.log("Joystick reset to center in Firebase"))
                .catch((error) => console.error("Error resetting direction:", error));
             // Display 'Stop' when joystick is centered
        });

        // Listen to toggle status from Firebase and log it










        
    </script>

      <!-- Include NippleJS Library -->
      <script src="https://unpkg.com/nipplejs@0.8.4/dist/nipplejs.js"></script>

     






      

      <script>






// âœ… Improved Hot Wake-Up Word Detection
// âœ… Improved Wake-Up Word Detection with Error Handling
function startWakeUpListener() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        console.error("âŒ Speech Recognition API is not supported in this browser.");
        alert("Speech Recognition API is not supported in this browser.");
        return;
    }

    let wakeUpRecognition = new SpeechRecognition();
    wakeUpRecognition.continuous = true; // Continuous listening
    wakeUpRecognition.lang = 'en-US';
    wakeUpRecognition.interimResults = false;

    let isRestarting = false; // Prevent multiple restarts
    let retryCount = 0; // Retry counter

    wakeUpRecognition.onstart = () => {
        console.log("âœ… Wake-Up Listener is active. Say 'Hey Wheelchair' to start.");
        isRestarting = false; // Reset restart flag
    };

    wakeUpRecognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
        console.log("ðŸŽ¤ Wake-Up Listener heard:", transcript);

        if (transcript.includes("hey wheelchair")) {
            console.log("ðŸš€ Wake-Up Word Detected! Starting speech recognition...");
            wakeUpRecognition.stop(); // Stop wake-up listener
            startSpeechRecognition(); // Trigger main speech recognition
        }
    };

    wakeUpRecognition.onerror = (event) => {
        console.error("âŒ Wake-Up Listener Error:", event.error);

        if (event.error === 'network') {
            console.warn("âš ï¸ Network error occurred. Pausing retries.");
            alert("âš ï¸ Network error occurred. Please check your internet connection and restart manually.");
            wakeUpRecognition.stop();
            return;
        }

        if (event.error === 'aborted') {
            console.warn("âš ï¸ Listener aborted. Restarting after delay...");
            restartWakeUpListener(3000); // Restart after 3 seconds
        }
    };

    wakeUpRecognition.onend = () => {
        console.log("ðŸ”„ Wake-Up Listener stopped. Restarting...");
        restartWakeUpListener(2000); // Restart after 2 seconds
    };

    // Restart listener with a cooldown to prevent multiple rapid restarts
    function restartWakeUpListener(delay = 2000) {
        if (isRestarting || retryCount >= 5) {
            console.warn("âš ï¸ Listener restart limit reached or already restarting.");
            alert("Wake-Up Listener failed to restart after multiple attempts. Please refresh the page.");
            return;
        }

        isRestarting = true; // Set restart flag
        retryCount++;
        setTimeout(() => {
            console.log(`ðŸ”„ Restarting Wake-Up Listener (Attempt ${retryCount})...`);
            startWakeUpListener(); // Restart after a delay
        }, delay);
    }

    wakeUpRecognition.start();
}

// âœ… Automatically Start Wake-Up Listener on Page Load
document.addEventListener('DOMContentLoaded', () => {
    startWakeUpListener();
});





let recognizer;
let isListening = false;

// âœ… Initialize TensorFlow Model
async function initializeWakeWordModel() {
    try {
        console.log('ðŸ”„ Initializing Wake Word Model...');
        recognizer = await speechCommands.create('BROWSER_FFT');
        await recognizer.ensureModelLoaded();
        console.log('âœ… Wake Word Model Loaded Successfully!');
    } catch (error) {
        console.error('âŒ Failed to load wake word model:', error);
    }
}

// âœ… Start Listening for Wake Word
async function startWakeUpListener() {
    if (!recognizer) {
        console.warn('âš ï¸ Model not loaded yet. Please wait.');
        return;
    }

    if (isListening) {
        console.warn('âš ï¸ Already listening for wake word.');
        return;
    }

    console.log('ðŸŽ¤ Listening for "Hey Wheelchair"...');
    isListening = true;

    recognizer.listen(result => {
        const scores = result.scores; // Probability scores for each word
        const words = recognizer.wordLabels(); // Word labels in the model

        // Find the word with the highest probability
        const maxScoreIndex = scores.indexOf(Math.max(...scores));
        const detectedWord = words[maxScoreIndex];

        console.log(`ðŸ—£ï¸ Detected Word: ${detectedWord}`);

        if (detectedWord === 'hello') {
            console.log('ðŸš€ Wake-Up Word Detected: Hey Wheelchair!');
            stopWakeUpListener();
            startSpeechRecognition();
        }
    }, {
        includeSpectrogram: false,
        probabilityThreshold: 0.75, // Adjust the confidence threshold
        invokeCallbackOnNoiseAndUnknown: false,
    });
}

// âœ… Stop Listening for Wake Word
function stopWakeUpListener() {
    if (recognizer && isListening) {
        recognizer.stopListening();
        isListening = false;
        console.log('ðŸ›‘ Stopped Listening for Wake Word.');
    }
}

// âœ… Start Wake-Up Listener on Page Load
document.addEventListener('DOMContentLoaded', async () => {
    await initializeWakeWordModel();
    startWakeUpListener();
});

function startSpeechRecognition() {
    console.log('ðŸŽ§ Starting Main Speech Recognition...');
    // Placeholder for your main speech recognition function
}




function toggleDisplay() {
    const toggleSwitch = document.getElementById('toggleSwitch');
    const joystickContainer = document.getElementById('joystick');
    const firebaseURL = 'https://smart-wheel-chair-eccdf-default-rtdb.firebaseio.com/motion/flag.json';

    if (toggleSwitch.checked) {
        joystickContainer.style.display = 'block'; // Show joystick when toggled on
        console.log('Toggle Status: ON');

        // Send data to Firebase
        fetch(firebaseURL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(1)
        })
        .then(response => {
            if (response.ok) {
                console.log('Successfully set flag to 1 in Firebase');
            } else {
                console.error('Failed to set flag to 1 in Firebase');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });

    } else {
        joystickContainer.style.display = 'none'; // Hide joystick when toggled off
        console.log('Toggle Status: OFF');

        // Send data to Firebase
        fetch(firebaseURL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(0)
        })
        .then(response => {
            if (response.ok) {
                console.log('Successfully set flag to 0 in Firebase');
            } else {
                console.error('Failed to set flag to 0 in Firebase');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}


          function startSpeechRecognition() {
        // Check if recognition is already active
        if (window.recognition && window.recognition.isListening) {
            console.log("Recognition is already active.");
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            console.error("Speech Recognition API not supported");
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.continuous = false; // Do not automatically restart
        recognition.isListening = true; // Custom flag to manage listening state

        window.recognition = recognition; // Assign to global variable for broader control

        recognition.onstart = () => {
            console.log("Voice recognition started. Speak now.");
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase();
            console.log("You said:", transcript);

            if (transcript.includes("start")) {
                document.getElementById('toggleSwitch').checked = true;
                toggleDisplay();
               
                console.log("Toggle enabled.");
            } else if (transcript.includes("stop")) {
                
                document.getElementById('toggleSwitch').checked = false;
                toggleDisplay();
                console.log("Toggle disabled.");
            }
        };


        recognition.onend = () => {
            console.log("Voice recognition stopped.");
            recognition.isListening = false; // Update flag when recognition ends
        };

        recognition.onerror = (event) => {
            console.error("Speech Recognition Error:", event.error);
            recognition.isListening = false;
        };

        recognition.start();
    }

    document.getElementById('startListeningBtn').addEventListener('click', startSpeechRecognition);
    document.addEventListener('DOMContentLoaded', checkToggleState);
      </script>
</body>
</html>
